# Diary.md

## 2024-06-29

### Наблюдения
- Проект имеет модульную структуру: отдельные директории для API, ML, миграций, тестов.
- Используются Supabase, joblib, Pydantic, shell-скрипты.
- Появилась задача интеграции с API Яндекс.Метрики для передачи офлайн-конверсий.
- Требуется приём и валидация POST-запросов с конверсиями.

### Проблемы
- Не определён точный стек для API (FastAPI или Flask?)
- Не реализована система авторизации.
- Нет явного CI/CD.
- Необходимо обеспечить безопасность вебхука (авторизация, фильтрация).
- Возможны ошибки при отправке в Яндекс.Метрику (сетевые, форматные).

### Решения
- Зафиксировать необходимость выбора и стандартизации API-фреймворка.
- Внедрить авторизацию на уровне API.
- Рассмотреть внедрение CI/CD для автоматизации деплоя.
- Внедрить отдельный эндпоинт с валидацией и логированием.
- Реализовать повторную отправку при ошибках.
- Защитить эндпоинт с помощью токенов/IP-фильтрации.

## 2024-07-01

### Наблюдения
- Реализован полный функционал вебхуков для офлайн-конверсий.
- Выбран FastAPI как основной фреймворк для API.
- Создана структура БД для хранения вебхуков и конверсий.
- Реализована асинхронная обработка и отправка конверсий в Яндекс.Метрику.
- Добавлена система безопасности на основе секретных ключей.

### Проблемы
- При отправке большого количества конверсий могут возникать задержки.
- Необходимо обеспечить надежную обработку ошибок и повторную отправку.
- Отсутствует UI для управления вебхуками.
- Нет автоматического мониторинга статусов отправки.

### Решения
- Реализована пакетная обработка конверсий для повышения производительности.
- Добавлена система статусов и отслеживания прогресса отправки.
- Внедрена валидация входящих данных на соответствие требованиям Яндекс.Метрики.
- Реализована проверка статусов загрузки в Яндекс.Метрике.
- Добавлена документация по работе с вебхуками.
- Спроектирована архитектура для масштабирования и расширения функционала.

### Технические детали
- Создана миграция для таблиц `webhooks`, `webhook_batches` и `webhook_conversions`.
- Реализованы модели данных на основе Pydantic.
- Добавлены эндпоинты для создания вебхуков, приема конверсий и проверки статуса.
- Реализована асинхронная обработка с использованием фоновых задач FastAPI.
- Внедрена система безопасности на основе заголовка `X-Webhook-Secret`.
- Добавлены триггеры в БД для автоматического обновления статусов и времени. 