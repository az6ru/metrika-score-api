# SystemArchitecture.md

## Общая архитектура API-системы для работы с Яндекс.Метрикой

---

# Потоки данных: Скоринговые конверсии и Офлайн-конверсии через вебхук

## 1. Скоринговые/аналитические конверсии (на основе данных о визитах)

### Жизненный цикл
1. **Авторизация пользователя** через Supabase
2. **Добавление Яндекс-аккаунта** (OAuth, хранение токена)
3. **Привязка счетчиков** к аккаунту
4. **Создание счетчика в Метрике через API** (если требуется)
5. **Проверка наличия цели '4plus'** на выбранном счетчике (через API управления Метрики)
6. **Получение данных о визитах** с выбранного счетчика через API отчетов Метрики
7. **Расчёт конверсий и скоринг** (ML/логика, на основе визитов и событий)
8. **Отправка рассчитанных конверсий** по цели '4plus' обратно в Метрику через API импорта

### Ключевые особенности
- Источник данных: только онлайн-данные Метрики (визиты, события, цели)
- Конверсии формируются внутри системы по аналитическим/ML-правилам
- Перед отправкой конверсий система проверяет, существует ли цель '4plus' на счетчике, и сообщает об ошибке или создает цель при необходимости
- Возможность создавать новые счетчики в Метрике через API управления
- Отправка в Метрику — для построения сквозной аналитики, ретаргетинга и т.д.
- Возможна автоматизация (по расписанию, по событию)

---

## 2. Офлайн-конверсии через вебхук

### Жизненный цикл
1. **Авторизация пользователя** через Supabase
2. **Добавление Яндекс-аккаунта** (OAuth, хранение токена)
3. **Привязка счетчиков** к аккаунту
4. **Создание вебхука** для выбранного счетчика через API (`POST /webhook/offline-conversions`)
5. **Приём офлайн-конверсий** через POST-запросы на вебхук (`POST /webhook/offline-conversions/{webhook_id}`)
6. **Валидация и хранение событий** в таблицах `webhook_batches` и `webhook_conversions`
7. **Отправка офлайн-конверсий** в Метрику через API импорта (асинхронная обработка)
8. **Проверка статуса отправки** через API (`GET /webhook/offline-conversions/{webhook_id}/status?batch_id={batch_id}`)

### Ключевые особенности
- Источник данных: внешние системы (CRM, телефония, POS и др.)
- Формат данных — строго по требованиям Метрики (ClientId/UserId/Yclid/PurchaseId, цель, время, цена, валюта)
- Вебхук — отдельный эндпоинт для каждого счетчика с уникальным ID и секретным ключом
- Безопасность обеспечивается через заголовок `X-Webhook-Secret`
- Асинхронная обработка и отправка в Метрику для повышения производительности
- Отслеживание статуса отправки и обработки конверсий
- Возможность отключения вебхука через флаг `is_active`

### Структура данных
1. **webhooks** - таблица с информацией о вебхуках
   - id: UUID (первичный ключ)
   - name: TEXT (название вебхука)
   - counter_id: INTEGER (ID счетчика Метрики)
   - token: TEXT (OAuth-токен для отправки конверсий)
   - description: TEXT (описание вебхука)
   - secret: TEXT (секретный ключ для авторизации запросов)
   - created_at: TIMESTAMP (дата создания)
   - updated_at: TIMESTAMP (дата обновления)
   - is_active: BOOLEAN (активность вебхука)

2. **webhook_batches** - таблица с информацией о пакетах конверсий
   - id: UUID (первичный ключ)
   - webhook_id: UUID (внешний ключ на таблицу webhooks)
   - counter_id: INTEGER (ID счетчика Метрики)
   - status: TEXT (статус пакета: pending, uploaded, processing, completed, error)
   - created_at: TIMESTAMP (дата создания)
   - updated_at: TIMESTAMP (дата обновления)
   - total: INTEGER (общее количество конверсий в пакете)
   - processed: INTEGER (количество обработанных конверсий)
   - metrika_upload_id: TEXT (ID загрузки в Метрике)
   - errors: TEXT[] (массив ошибок)

3. **webhook_conversions** - таблица с информацией о конверсиях
   - id: UUID (первичный ключ)
   - batch_id: UUID (внешний ключ на таблицу webhook_batches)
   - client_id: TEXT (идентификатор клиента Метрики)
   - user_id: TEXT (идентификатор пользователя)
   - yclid: TEXT (идентификатор клика Яндекс.Директ)
   - purchase_id: TEXT (идентификатор покупки)
   - target: TEXT (название цели)
   - date_time: TEXT (дата и время конверсии)
   - price: NUMERIC (ценность цели)
   - currency: TEXT (валюта)
   - status: TEXT (статус конверсии: pending, processed, error)
   - created_at: TIMESTAMP (дата создания)
   - updated_at: TIMESTAMP (дата обновления)
   - error: TEXT (сообщение об ошибке)

---

## 3. Общий модуль отправки конверсий в Метрику
- Унифицирует процесс передачи любых конверсий (скоринговых и офлайн) в нужный счетчик
- Использует сохранённый OAuth-токен, поддерживает статусы загрузки, повторные попытки, логирование ошибок
- Для скоринговых конверсий используется модуль `send_conversions.py`
- Для офлайн-конверсий из вебхуков используется модуль `send_webhook_conversions.py`

---

## Схема потоков данных

```mermaid
flowchart TD
    subgraph Скоринговые конверсии
        A1[Supabase Auth] --> A2[OAuth Яндекс]
        A2 --> A3[Привязка счетчиков]
        A3 --> A3a[Создание счетчика (опц.)]
        A3a --> A3b[Проверка цели 4plus]
        A3b --> A4[Получение визитов]
        A4 --> A5[Расчёт конверсий/скоринг]
        A5 --> C[Модуль отправки в Метрику]
    end
    subgraph Офлайн-конверсии (вебхук)
        B1[Внешняя система] --> B2[POST на вебхук]
        B2 --> B3[Валидация и сохранение]
        B3 --> B4[Формирование CSV]
        B4 --> C
    end
    C --> D[API Метрики: импорт конверсий]
    D --> E[Проверка статуса]
    E --> F[Обновление статуса в БД]
```

---

## API-эндпоинты для вебхуков

### 1. Создание вебхука
- **Метод**: POST
- **URL**: `/webhook/offline-conversions`
- **Тело запроса**:
  ```json
  {
    "name": "CRM System",
    "counter_id": 12345678,
    "token": "y0_AgAAAABpQkVZAAo1DQAAAADrJOF9YTQzNmE5OTg5NDQwMjk5OWE1YzRkYmNiNTZkMmYxMg",
    "description": "Webhook for CRM system"
  }
  ```
- **Ответ**:
  ```json
  {
    "webhook_id": "550e8400-e29b-41d4-a716-446655440000",
    "secret": "KzBWYXzDPrfzv3LpUhWBqNX8JQnbGc_wEKUzUhM7uyA",
    "url": "https://api.example.com/webhook/offline-conversions/550e8400-e29b-41d4-a716-446655440000"
  }
  ```

### 2. Отправка конверсий через вебхук
- **Метод**: POST
- **URL**: `/webhook/offline-conversions/{webhook_id}`
- **Заголовки**: `X-Webhook-Secret: {secret}`
- **Тело запроса**:
  ```json
  {
    "conversions": [
      {
        "client_id": "1234567890.1234567890",
        "target": "purchase",
        "date_time": "2025-07-01T12:34:56",
        "price": 1500,
        "currency": "RUB",
        "purchase_id": "order123"
      }
    ]
  }
  ```
- **Ответ**:
  ```json
  {
    "batch_id": "550e8400-e29b-41d4-a716-446655440001",
    "status": "accepted",
    "accepted_count": 1
  }
  ```

### 3. Проверка статуса отправки
- **Метод**: GET
- **URL**: `/webhook/offline-conversions/{webhook_id}/status?batch_id={batch_id}`
- **Заголовки**: `X-Webhook-Secret: {secret}`
- **Ответ**:
  ```json
  {
    "batch_id": "550e8400-e29b-41d4-a716-446655440001",
    "status": "completed",
    "webhook_id": "550e8400-e29b-41d4-a716-446655440000",
    "counter_id": 12345678,
    "created_at": "2025-07-01T12:35:00Z",
    "updated_at": "2025-07-01T12:36:30Z",
    "metrika_upload_id": "987654",
    "total": 1,
    "processed": 1,
    "errors": null
  }
  ```

---

## Примечания
- Оба потока независимы по источнику и логике формирования, но используют общий механизм отправки в Метрику.
- В системе можно реализовать мониторинг, аудит, повторные попытки и уведомления для обоих потоков.
- Подробная документация по вебхукам доступна в [docs/WebhookOfflineConversions.md](WebhookOfflineConversions.md)

## Краткая схема взаимодействия

1. Пользователь → (Supabase Auth) → Личный кабинет
2. Личный кабинет → (OAuth) → Привязка Яндекс-аккаунта → Получение токена
3. Система → (API Метрики) → Получение и выбор счетчиков
4. Система → (API Метрики) → Получение данных о визитах
5. Система → (ML/логика) → Расчёт конверсий и скоринг
6. Для счетчика → (создание вебхука) → Приём офлайн-конверсий
7. Система → (API Метрики) → Отправка данных в выбранный счетчик

---

## Возможности для расширения
- Управление правами доступа (несколько пользователей на workspace)
- История загрузок, мониторинг статусов, уведомления о неудачных отправках
- UI для управления аккаунтами, счетчиками, вебхуками
- Интеграция с другими рекламными платформами
- Добавление поддержки других типов конверсий (например, электронная коммерция)
- Расширение API для управления вебхуками (обновление, удаление, получение списка)

---

## Примечания
- Все ключевые действия логируются и доступны для аудита.
- Безопасность обеспечивается на уровне Supabase и OAuth Яндекс.
- Система масштабируема для работы с большим количеством пользователей и счетчиков. 