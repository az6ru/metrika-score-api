# Вебхуки для офлайн-конверсий

## Общее описание

Вебхуки для офлайн-конверсий позволяют принимать данные о конверсиях из внешних систем и отправлять их в Яндекс.Метрику. Этот механизм особенно полезен для интеграции с CRM-системами, кассовыми аппаратами и другими источниками данных о продажах и конверсиях.

## Архитектура

```
                 ┌───────────────┐
                 │               │
                 │  Внешняя      │
                 │  система      │
                 │               │
                 └───────┬───────┘
                         │
                         │ POST /webhook/offline-conversions/{webhook_id}
                         │ X-Webhook-Secret: {secret}
                         ▼
┌─────────────────────────────────────────────┐
│                                             │
│  Metrika Score API                          │
│                                             │
│  ┌─────────────┐       ┌─────────────────┐  │
│  │             │       │                 │  │
│  │ Валидация   ├──────▶│ Сохранение в БД │  │
│  │             │       │                 │  │
│  └─────────────┘       └────────┬────────┘  │
│                                 │           │
│                                 ▼           │
│                        ┌─────────────────┐  │
│                        │                 │  │
│                        │ Отправка в      │  │
│                        │ Яндекс.Метрику  │  │
│                        │                 │  │
│                        └─────────────────┘  │
│                                             │
└─────────────────────────────────────────────┘
```

## Процесс работы с вебхуками

1. **Создание вебхука**
   - Вызов API для создания нового вебхука
   - Получение уникального URL и секретного ключа
   - Настройка внешней системы для отправки данных на полученный URL

2. **Отправка конверсий**
   - Внешняя система отправляет данные о конверсиях на URL вебхука
   - API валидирует запрос и сохраняет данные в базу
   - Запускается фоновая задача для отправки данных в Яндекс.Метрику

3. **Проверка статуса**
   - Внешняя система может проверить статус отправки конверсий
   - API возвращает информацию о статусе, количестве обработанных конверсий и ошибках

## Эндпоинты API

### Создание вебхука

```
POST /webhook/offline-conversions
```

**Запрос:**
```json
{
  "name": "CRM System",
  "counter_id": 12345678,
  "token": "y0_AgAAAABpQkVZAAo1DQAAAADrJOF9YTQzNmE5OTg5NDQwMjk5OWE1YzRkYmNiNTZkMmYxMg",
  "description": "Webhook for CRM system"
}
```

**Ответ:**
```json
{
  "webhook_id": "550e8400-e29b-41d4-a716-446655440000",
  "secret": "KzBWYXzDPrfzv3LpUhWBqNX8JQnbGc_wEKUzUhM7uyA",
  "url": "https://api.example.com/webhook/offline-conversions/550e8400-e29b-41d4-a716-446655440000"
}
```

### Отправка конверсий

```
POST /webhook/offline-conversions/{webhook_id}
X-Webhook-Secret: {secret}
```

**Запрос:**
```json
{
  "conversions": [
    {
      "client_id": "1234567890.1234567890",
      "target": "purchase",
      "date_time": "2025-07-01T12:34:56",
      "price": 1500,
      "currency": "RUB",
      "purchase_id": "order123"
    },
    {
      "user_id": "user123",
      "target": "registration",
      "date_time": "2025-07-01T12:30:00"
    }
  ]
}
```

**Ответ:**
```json
{
  "batch_id": "550e8400-e29b-41d4-a716-446655440001",
  "status": "accepted",
  "accepted_count": 2
}
```

### Проверка статуса

```
GET /webhook/offline-conversions/{webhook_id}/status?batch_id={batch_id}
X-Webhook-Secret: {secret}
```

**Ответ:**
```json
{
  "batch_id": "550e8400-e29b-41d4-a716-446655440001",
  "status": "completed",
  "webhook_id": "550e8400-e29b-41d4-a716-446655440000",
  "counter_id": 12345678,
  "created_at": "2025-07-01T12:35:00Z",
  "updated_at": "2025-07-01T12:36:30Z",
  "metrika_upload_id": "987654",
  "total": 2,
  "processed": 2,
  "errors": null
}
```

## Статусы обработки

- **accepted** - конверсии приняты и сохранены в базу
- **pending** - конверсии ожидают отправки в Яндекс.Метрику
- **uploaded** - конверсии отправлены в Яндекс.Метрику
- **processing** - конверсии обрабатываются в Яндекс.Метрике
- **completed** - конверсии успешно обработаны
- **error** - произошла ошибка при обработке конверсий

## Формат данных

### Обязательные поля

- **target** - название цели в Яндекс.Метрике
- **date_time** - дата и время конверсии в формате ISO 8601

### Идентификаторы (требуется хотя бы один)

- **client_id** - идентификатор посетителя сайта, назначенный Яндекс.Метрикой
- **user_id** - идентификатор посетителя сайта, назначенный владельцем сайта
- **yclid** - идентификатор клика по рекламному объявлению Яндекс.Директа

### Дополнительные поля

- **purchase_id** - идентификатор покупки
- **price** - ценность цели
- **currency** - валюта в формате ISO 4217 (например, RUB)

## Безопасность

- Каждый вебхук имеет уникальный идентификатор и секретный ключ
- Секретный ключ должен передаваться в заголовке `X-Webhook-Secret`
- Рекомендуется использовать HTTPS для защиты данных при передаче
- Вебхуки можно отключить, установив флаг `is_active` в `false`

## Обработка ошибок

- При ошибке валидации запроса возвращается код 400 Bad Request
- При неверном секретном ключе возвращается код 403 Forbidden
- При ошибке сервера возвращается код 500 Internal Server Error
- Подробная информация об ошибках доступна в поле `errors` при проверке статуса

## Примеры использования

### Интеграция с CRM

```python
import requests
import json

# Данные для отправки
data = {
    "conversions": [
        {
            "client_id": "1234567890.1234567890",
            "target": "purchase",
            "date_time": "2025-07-01T12:34:56",
            "price": 1500,
            "currency": "RUB",
            "purchase_id": "order123"
        }
    ]
}

# Отправка запроса
response = requests.post(
    "https://api.example.com/webhook/offline-conversions/550e8400-e29b-41d4-a716-446655440000",
    headers={"X-Webhook-Secret": "KzBWYXzDPrfzv3LpUhWBqNX8JQnbGc_wEKUzUhM7uyA"},
    json=data
)

# Получение результата
result = response.json()
print(f"Batch ID: {result['batch_id']}")
print(f"Status: {result['status']}")
print(f"Accepted: {result['accepted_count']}")

# Проверка статуса
status_response = requests.get(
    f"https://api.example.com/webhook/offline-conversions/550e8400-e29b-41d4-a716-446655440000/status?batch_id={result['batch_id']}",
    headers={"X-Webhook-Secret": "KzBWYXzDPrfzv3LpUhWBqNX8JQnbGc_wEKUzUhM7uyA"}
)

status = status_response.json()
print(f"Status: {status['status']}")
print(f"Processed: {status['processed']}/{status['total']}")
```

## Ограничения

- Максимальное количество конверсий в одном запросе: 1000
- Максимальное количество запросов в минуту: 60
- Максимальный размер запроса: 10 МБ

## Рекомендации

- Используйте пакетную отправку конверсий для повышения производительности
- Проверяйте статус отправки для подтверждения успешной обработки
- Сохраняйте ID пакета для последующей проверки статуса
- Реализуйте механизм повторной отправки при ошибках
- Настройте мониторинг для отслеживания ошибок и задержек 